import { expect, test } from "../fixtures";

import { VulnerabilityService } from "../client";
import { qBuilder } from "../helpers/params";

test("Filter Vulnerabilities by severity - vanilla", async ({ axios }) => {
  // URLSearchParams ensures escaping special characters
  // Without URLSearchParams we would need to do something like:
  // axios.get("/api/v2/vulnerability?limit=10&offset=0&q=CVE-2023-2%26average_severity%3Dmedium%7Chigh&sort=published:asc")
  const queryParams = new URLSearchParams();
  queryParams.append("offset", "0");
  queryParams.append("limit", "10");
  queryParams.append("sort", "published:asc");
  queryParams.append("q", "CVE-2023-2&average_severity=medium|high");

  const serviceResponse = await axios.get("/api/v2/vulnerability", {
    params: queryParams,
  });

  expect(serviceResponse.data).toEqual(
    expect.objectContaining({
      total: 13,
    })
  );
});

test("Filter Vulnerabilities by severity - openapi", async ({ client }) => {
  const serviceResponse = await VulnerabilityService.listVulnerabilities({
    client,
    query: {
      offset: 0,
      limit: 10,
      sort: "published:asc",
      q: qBuilder("CVE-2023-2", [
        {
          field: "average_severity",
          operator: "=",
          value: {
            list: ["medium", "high"],
            operator: "OR",
          },
        },
      ]),
    },
  });

  expect(serviceResponse.data).toEqual(
    expect.objectContaining({
      total: 13,
    })
  );
});
